{{!-- assets/javascripts/discourse/templates/market.hbs --}}
<div class="dk-market-page">
  <nav class="market-tabs">
    <button
      type="button"
      class="tab {{if (eq this.activeTab 'shop') 'active'}}"
      {{on "click" (fn this.selectTab 'shop')}}
    >
      상점
    </button>
    <button
      type="button"
      class="tab {{if (eq this.activeTab 'my') 'active'}}"
      {{on "click" (fn this.selectTab 'my')}}
    >
      내 아이템
    </button>
  </nav>

  {{!-- ================= SHOP TAB ================= --}}
  {{#if (eq this.activeTab 'shop')}}
    <h1 class="market-title">Market</h1>

    {{#if @model.length}}
      {{#each @model as |group|}}
        <section class="market-section">
          <h2 class="market-section-title">{{group.category}}</h2>

          <div class="market-grid">
            {{#each group.items as |item|}}
              <article class="market-card">
                <div class="market-media">
                  {{#if item.image_url}}
                    <img class="market-thumb" src={{item.image_url}} alt={{item.name}} loading="lazy" />
                  {{else}}
                    <img class="market-thumb" src={{get-url "/images/no_image.png"}} alt="No Image" loading="lazy" />
                  {{/if}}
                </div>

                <div class="market-info">
                  <h3 class="market-name">{{item.name}}</h3>

                  <div class="market-price-row">
                    <span class="market-price">{{item.price_points}} pts</span>
                    {{#if item.is_limited_duration}}
                      <span class="badge badge-duration">기간제 {{item.duration_days}}일</span>
                    {{/if}}
                  </div>

                  {{#if item.owned}}
                    <div class="market-sub owned">보유중</div>
                  {{else if item.duplicate_policy}}
                    <div class="market-sub">중복: {{item.duplicate_policy}}</div>
                  {{/if}}

                  <button
                    class="btn buy-btn"
                    disabled={{item.owned}}
                    aria-disabled={{item.owned}}
                    title={{if item.owned "이미 보유한 아이템입니다" "구매하기"}}
                  >
                    {{if item.owned "OWNED" "BUY NOW"}}
                  </button>
                </div>
              </article>
            {{/each}}
          </div>
        </section>
      {{/each}}
    {{else}}
      <p class="market-empty">활성화된 아이템이 없습니다.</p>
    {{/if}}

  {{!-- ================= MY ITEMS TAB ================= --}}
  {{else}}
    <h1 class="market-title">My Items</h1>

    {{#if this.isLoadingMyItems}}
      <p class="market-empty">Loading...</p>
    {{else if this.myItems}}
      {{#if this.myItems.length}}
        {{#each this.myItems as |group|}}
          <section class="market-section">
            <h2 class="market-section-title">{{group.category}}</h2>

            <div class="market-grid">
              {{#each group.items as |item|}}
                <article class="market-card">
                  <div class="market-media">
                    {{#if item.image_url}}
                      <img class="market-thumb" src={{item.image_url}} alt={{item.name}} loading="lazy" />
                    {{else}}
                      <img class="market-thumb" src={{get-url "/images/no_image.png"}} alt="No Image" loading="lazy" />
                    {{/if}}
                  </div>

                  <div class="market-info">
                    <h3 class="market-name">{{item.name}}</h3>

                    <button
                      class="btn use-btn"
                      disabled={{eq this.togglingId item.inventory_id}}
                      aria-disabled={{eq this.togglingId item.inventory_id}}
                      title={{if (eq this.togglingId item.inventory_id) "처리 중..." (if item.is_used "해제" "장착")}}
                      {{on "click" (fn this.toggleUse item)}}
                    >
                      {{#if (eq this.togglingId item.inventory_id)}}
                        Processing...
                      {{else}}
                        {{if item.is_used "UNEQUIP" "EQUIP"}}
                      {{/if}}
                    </button>
                  </div>
                </article>
              {{/each}}
            </div>
          </section>
        {{/each}}
      {{else}}
        <p class="market-empty">보유한 아이템이 없습니다.</p>
      {{/if}}
    {{else}}
      <p class="market-empty">Loading...</p>
    {{/if}}
  {{/if}}
</div>
